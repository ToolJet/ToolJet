name: Deploy to Vercel

# This workflow deploys the ToolJet frontend to Vercel using the official pattern
# Pattern: vercel pull ‚Üí vercel build ‚Üí vercel deploy --prebuilt
# This approach bypasses the "git author must have access to team" error
#
# Required GitHub Secrets:
# - VERCEL_TOKEN: Vercel API token (get from https://vercel.com/account/tokens)
# - VERCEL_ORG_ID: team_SsaGMOGYsC8KFX3InHcUiy3T
# - VERCEL_PROJECT_ID: prj_iX5rpyQy7hq8upcHijcED3jkRQn4
# - CUSTOM_GITHUB_TOKEN: For submodule checkout
# - ALLOWED_USER1_USERNAME, ALLOWED_USER2_USERNAME, ALLOWED_USER3_USERNAME: Authorized users
#
# Vercel Project Configuration (must be set in Vercel Dashboard):
# - Build Command: npm run build:plugins:prod && npm run build:frontend
# - Output Directory: frontend/build
# - Install Command: npm install
# - Node.js Version: 22.15.1

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Git branch to deploy (must start with "lts-", e.g., lts-3.16)'
        required: true
      environment:
        description: "Deployment environment"
        required: true
        type: choice
        options:
          - preview
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ‚úÖ Check user authorization
        run: |
          allowed_user1=${{ secrets.ALLOWED_USER1_USERNAME }}
          allowed_user2=${{ secrets.ALLOWED_USER2_USERNAME }}
          allowed_user3=${{ secrets.ALLOWED_USER3_USERNAME }}

          if [[ "${{ github.actor }}" != "$allowed_user1" && \
                "${{ github.actor }}" != "$allowed_user2" && \
                "${{ github.actor }}" != "$allowed_user3" ]]; then
            echo "‚ùå User '${{ github.actor }}' is not authorized to trigger this workflow."
            exit 1
          else
            echo "‚úÖ User '${{ github.actor }}' is authorized."
          fi

      - name: üì• Manual Git checkout with submodules
        run: |
          set -e

          BRANCH="${{ github.event.inputs.branch }}"
          REPO="https://x-access-token:${{ secrets.CUSTOM_GITHUB_TOKEN }}@github.com/${{ github.repository }}"

          git config --global url."https://x-access-token:${{ secrets.CUSTOM_GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
          git config --global http.version HTTP/1.1
          git config --global http.postBuffer 524288000

          echo "üëâ Cloning $REPO (branch: $BRANCH)"
          git clone --recurse-submodules --depth=1 --branch "$BRANCH" "$REPO" repo
          cd repo

          echo "üîé Main repo: verifying checkout"
          MAIN_CURRENT=$(git rev-parse --abbrev-ref HEAD)
          echo "‚úÖ Main repo: successfully checked out branch $MAIN_CURRENT"
          echo "üìç Main repo: current commit $(git rev-parse --short HEAD): $(git log -1 --pretty=%s)"

          echo "üîÅ Updating submodules"
          git submodule update --init --recursive

          echo "üîÄ Attempting to checkout '$BRANCH' in each submodule and validating"

          BRANCH="$BRANCH" git submodule foreach --recursive bash -c '
            name="$sm_path"
            echo ""
            echo "Entering '\''$name'\''"
            echo "‚Ü™ $name: trying to checkout branch '\''$BRANCH'\''"

            if git ls-remote --exit-code --heads origin "$BRANCH" >/dev/null; then
              git fetch origin "$BRANCH:$BRANCH" || {
                echo "‚ùå $name: fetch failed for $BRANCH"
                exit 1
              }

              PREV=$(git rev-parse --short HEAD || echo "unknown")
              git checkout "$BRANCH" || {
                echo "‚ùå $name: checkout failed for $BRANCH"
                exit 1
              }

              echo "Previous HEAD position was $PREV: $(git log -1 --pretty=%s || echo '\''unknown'\'')"
              echo "‚úÖ $name: checked out branch $BRANCH"
            else
              echo "‚ö†Ô∏è $name: branch '\''$BRANCH'\'' not found on origin. Falling back to '\''lts-3.16'\''"
              PREV=$(git rev-parse --short HEAD || echo "unknown")
              git fetch origin lts-3.16:lts-3.16 || {
                echo "‚ùå $name: fetch failed for lts-3.16"
                exit 1
              }
              git checkout lts-3.16 || {
                echo "‚ùå $name: fallback to lts-3.16 failed"
                exit 1
              }
              echo "Previous HEAD position was $PREV: $(git log -1 --pretty=%s || echo '\''unknown'\'')"
              echo "‚úÖ $name: now on branch lts-3.16"
            fi

            CURRENT=$(git rev-parse --abbrev-ref HEAD)
            echo "üîé $name: current branch = $CURRENT"
            if [ "$CURRENT" != "$BRANCH" ] && [ "$CURRENT" != "lts-3.16" ]; then
              echo "‚ùå $name: unexpected branch state ‚Äî wanted '\''$BRANCH'\'' or fallback '\''lts-3.16'\'', got '\''$CURRENT'\''"
              exit 1
            fi
          '

      - name: üß∞ Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 22.15.1

      - name: üì¶ Install Vercel CLI
        run: npm install -g vercel@latest

      - name: üîΩ Pull Vercel Environment Information
        run: |
          cd repo
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            echo "üîΩ Pulling Vercel production environment configuration..."
            vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          else
            echo "üîΩ Pulling Vercel preview environment configuration..."
            vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
          fi

      - name: üì¶ Install dependencies
        run: npm install
        working-directory: repo

      - name: üõ†Ô∏è Build Project with Vercel
        run: |
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            echo "üõ†Ô∏è Building for production..."
            vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          else
            echo "üõ†Ô∏è Building for preview..."
            vercel build --token=${{ secrets.VERCEL_TOKEN }}
          fi
        working-directory: repo
        env:
          GOOGLE_MAPS_API_KEY: ${{ secrets.CLOUD_GOOGLE_MAPS_API_KEY }}
          NODE_ENV: ${{ secrets.CLOUD_NODE_ENV }}
          NODE_OPTIONS: ${{ secrets.CLOUD_NODE_OPTIONS }}
          SERVE_CLIENT: ${{ secrets.CLOUD_SERVE_CLIENT }}
          SERVER_IP: ${{ secrets.CLOUD_SERVER_IP }}
          TJDB_SQL_MODE_DISABLE: ${{ secrets.CLOUD_TJDB_SQL_MODE_DISABLE }}
          TOOLJET_SERVER_URL: ${{ secrets.CLOUD_TOOLJET_SERVER_URL }}
          WEBSITE_SIGNUP_URL: https://website-stage.tooljet.ai/signup
          TOOLJET_EDITION: cloud

      - name: üöÄ Deploy Pre-built Artifacts to Vercel
        run: |
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            echo "üöÄ Deploying pre-built artifacts to production..."
            vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
          else
            echo "üöÄ Deploying pre-built artifacts to preview..."
            vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }}
          fi
        working-directory: repo
