name: Docker Image Vulnerability Scan

on:
  # Trigger automatically when Script A completes on develop branch
  workflow_run:
    workflows: ["Manual Docker Build and Push"]
    types:
      - completed
    branches:
      - develop
  
  # Manual trigger option - must provide image name
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Docker image to scan (e.g., tooljet/tj-osv:pre-release-14)'
        required: true

jobs:
  vulnerability-scan:
    runs-on: ubuntu-latest
    
    # Only run if Script A succeeded (when triggered by workflow_run)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker tag artifact (for auto-trigger)
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          name: docker-image-tag
          path: ./artifacts
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image name
        id: set-image
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger - use input from user
            echo "IMAGE_NAME=${{ github.event.inputs.image_name }}" >> $GITHUB_ENV
            echo "ðŸ” Manual scan requested for: ${{ github.event.inputs.image_name }}"
          else
            # Auto trigger - read from artifact created by Script A
            if [ -f ./artifacts/docker-image-tag.txt ]; then
              IMAGE_TAG=$(cat ./artifacts/docker-image-tag.txt)
              echo "IMAGE_NAME=$IMAGE_TAG" >> $GITHUB_ENV
              echo "âœ… Auto-scanning image from Script A: $IMAGE_TAG"
            else
              echo "âŒ ERROR: Could not find docker-image-tag.txt artifact from Script A"
              echo "Make sure Script A has the artifact upload steps configured"
              exit 1
            fi
          fi
          
          echo "ðŸ” Scanning image: $IMAGE_NAME"

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Pull Docker image
        run: |
          echo "Pulling image: ${{ env.IMAGE_NAME }}"
          docker pull ${{ env.IMAGE_NAME }}

      - name: Generate SBOM with Syft
        run: |
          echo "Generating SBOM for ${{ env.IMAGE_NAME }}..."
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v "$PWD":/project \
            -w /project \
            anchore/syft:latest \
            docker:${{ env.IMAGE_NAME }} -o json > syft-sbom.json
          
          echo "âœ… SBOM generated successfully"

      - name: Run Grype vulnerability scan
        run: |
          echo "Running vulnerability scan..."
          docker run --rm \
            -v "$PWD":/project \
            -w /project \
            anchore/grype:latest \
            sbom:syft-sbom.json -o json > vulnerability-report.json
          
          echo "âœ… Vulnerability scan completed"

      - name: Parse and display vulnerability summary
        id: parse-vulns
        run: |
          echo "================================================"
          echo "     VULNERABILITY SCAN SUMMARY"
          echo "================================================"
          echo "Image: ${{ env.IMAGE_NAME }}"
          echo ""
          
          # Parse counts
          CRITICAL=$(jq '[.matches[] | select(.vulnerability.severity == "Critical")] | length' vulnerability-report.json)
          HIGH=$(jq '[.matches[] | select(.vulnerability.severity == "High")] | length' vulnerability-report.json)
          MEDIUM=$(jq '[.matches[] | select(.vulnerability.severity == "Medium")] | length' vulnerability-report.json)
          LOW=$(jq '[.matches[] | select(.vulnerability.severity == "Low")] | length' vulnerability-report.json)
          NEGLIGIBLE=$(jq '[.matches[] | select(.vulnerability.severity == "Negligible")] | length' vulnerability-report.json)
          TOTAL=$((CRITICAL + HIGH + MEDIUM + LOW + NEGLIGIBLE))
          
          # Save to environment
          echo "CRITICAL=$CRITICAL" >> $GITHUB_ENV
          echo "HIGH=$HIGH" >> $GITHUB_ENV
          echo "MEDIUM=$MEDIUM" >> $GITHUB_ENV
          echo "LOW=$LOW" >> $GITHUB_ENV
          echo "NEGLIGIBLE=$NEGLIGIBLE" >> $GITHUB_ENV
          echo "TOTAL=$TOTAL" >> $GITHUB_ENV
          
          # Display summary
          echo "ðŸ”´ Critical:    $CRITICAL"
          echo "ðŸŸ  High:        $HIGH"
          echo "ðŸŸ¡ Medium:      $MEDIUM"
          echo "ðŸŸ¢ Low:         $LOW"
          echo "âšª Negligible:  $NEGLIGIBLE"
          echo "ðŸ“¦ Total:       $TOTAL"
          echo ""
          echo "================================================"

      - name: Display Critical vulnerabilities
        if: env.CRITICAL != '0'
        run: |
          echo ""
          echo "================================================"
          echo "     ðŸ”´ CRITICAL VULNERABILITIES"
          echo "================================================"
          
          jq -r '.matches[] | 
            select(.vulnerability.severity == "Critical") |
            "
          CVE: \(.vulnerability.id)
          Package: \(.artifact.name) v\(.artifact.version)
          Severity: \(.vulnerability.severity)
          Fixed in: \(.vulnerability.fix.versions // ["Not available"] | join(", "))
          Description: \(.vulnerability.description // "N/A")
          CVSS Score: \(.vulnerability.cvss[0].metrics.baseScore // "N/A")
          ------------------------------------------------"' vulnerability-report.json

      - name: Display High vulnerabilities
        if: env.HIGH != '0'
        run: |
          echo ""
          echo "================================================"
          echo "     ðŸŸ  HIGH VULNERABILITIES"
          echo "================================================"
          
          jq -r '.matches[] | 
            select(.vulnerability.severity == "High") |
            "
          CVE: \(.vulnerability.id)
          Package: \(.artifact.name) v\(.artifact.version)
          Severity: \(.vulnerability.severity)
          Fixed in: \(.vulnerability.fix.versions // ["Not available"] | join(", "))
          Description: \(.vulnerability.description // "N/A")
          CVSS Score: \(.vulnerability.cvss[0].metrics.baseScore // "N/A")
          ------------------------------------------------"' vulnerability-report.json

      - name: Display Medium vulnerabilities
        if: env.MEDIUM != '0'
        run: |
          echo ""
          echo "================================================"
          echo "     ðŸŸ¡ MEDIUM VULNERABILITIES"
          echo "================================================"
          
          jq -r '.matches[] | 
            select(.vulnerability.severity == "Medium") |
            "
          CVE: \(.vulnerability.id)
          Package: \(.artifact.name) v\(.artifact.version)
          Fixed in: \(.vulnerability.fix.versions // ["Not available"] | join(", "))
          ------------------------------------------------"' vulnerability-report.json | head -n 50
                    
                    MEDIUM_COUNT=$(jq '[.matches[] | select(.vulnerability.severity == "Medium")] | length' vulnerability-report.json)
                    if [ "$MEDIUM_COUNT" -gt 10 ]; then
                      echo ""
                      echo "... and $((MEDIUM_COUNT - 10)) more medium vulnerabilities"
                      echo "Check full logs for complete list"
                    fi

      - name: Determine scan status
        id: scan-status
        run: |
          if [ "${{ env.CRITICAL }}" -gt 0 ]; then
            echo "STATUS=ðŸ”´ CRITICAL" >> $GITHUB_ENV
          elif [ "${{ env.HIGH }}" -gt 0 ]; then
            echo "STATUS=ðŸŸ  WARNING" >> $GITHUB_ENV
          else
            echo "STATUS=ðŸŸ¢ PASSED" >> $GITHUB_ENV
          fi

      - name: Prepare detailed CVE list for Slack
        id: prepare-slack
        run: |
          # Extract critical and high vulnerabilities for Slack
          CVE_DETAILS=$(jq -r '.matches[] | 
            select(.vulnerability.severity == "Critical" or .vulnerability.severity == "High") |
            "â€¢ \(.vulnerability.id) [\(.vulnerability.severity)] - \(.artifact.name) v\(.artifact.version) â†’ Fixed: \(.vulnerability.fix.versions // ["N/A"] | join(", "))"' \
            vulnerability-report.json | head -n 20)
          
          # Escape for JSON
          CVE_DETAILS_ESCAPED=$(echo "$CVE_DETAILS" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
          echo "CVE_DETAILS<<EOF" >> $GITHUB_ENV
          echo "$CVE_DETAILS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          # Count total critical + high
          CRITICAL_HIGH_COUNT=$((CRITICAL + HIGH))
          if [ "$CRITICAL_HIGH_COUNT" -gt 20 ]; then
            echo "TRUNCATED_MSG=... and $((CRITICAL_HIGH_COUNT - 20)) more critical/high vulnerabilities. Check logs for full list." >> $GITHUB_ENV
          else
            echo "TRUNCATED_MSG=" >> $GITHUB_ENV
          fi

      - name: Send Slack notification
        run: |
          message="ðŸ”’ Docker Image Vulnerability Scan Report\n
          Image: ${{ env.IMAGE_NAME }}\n
          Status: ${{ env.STATUS }}\n
          \nVulnerability Summary:\n
          ðŸ”´ Critical: ${{ env.CRITICAL }}\n
          ðŸŸ  High: ${{ env.HIGH }}\n
          ðŸŸ¡ Medium: ${{ env.MEDIUM }}\n
          ðŸŸ¢ Low: ${{ env.LOW }}\n
          âšª Negligible: ${{ env.NEGLIGIBLE }}\n
          ðŸ“¦ Total: ${{ env.TOTAL }}\n
          \nView Full Report: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"$message\"}" ${{ secrets.SLACK_WEBHOOK_URL_VUR }}

      - name: Send detailed CVE list to Slack
        if: env.CRITICAL != '0' || env.HIGH != '0'
        run: |
          detail_message="ðŸš¨ Critical & High Severity Vulnerabilities\n
          Image: ${{ env.IMAGE_NAME }}\n
          \n${{ env.CVE_DETAILS }}\n
          \n${{ env.TRUNCATED_MSG }}\n
          \nFull details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"$detail_message\"}" ${{ secrets.SLACK_WEBHOOK_URL_VUR }}

      - name: Cleanup temporary files
        if: always()
        run: |
          rm -f syft-sbom.json vulnerability-report.json
          echo "âœ… Cleanup completed"