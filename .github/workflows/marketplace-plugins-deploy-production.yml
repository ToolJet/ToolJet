name: Marketplace Plugin Production Deploy

on:
    pull_request_target:
        types: [labeled, unlabeled, closed]

    workflow_dispatch:
        inputs:
            branch:
                description: "Branch to deploy from"
                required: true
                default: "lts-3.16"
            plugin_name:
                description: "Plugin name to deploy individually (leave empty to deploy all)"
                required: false
                default: ""

env:
    PR_NUMBER: ${{ github.event.number }}
    BRANCH_NAME: ${{ github.event.inputs.branch || github.head_ref || github.ref_name }}

jobs:
    deploy-marketplace-plugin-production:
        if: |
            github.event_name == 'workflow_dispatch' ||
            (github.event.action == 'labeled' && github.event.label.name == 'deploy-marketplace-plugin-prod')
        runs-on: ubuntu-latest
        steps:
            - name: ‚úÖ Check user authorization
              run: |
                  allowed_user1="${{ secrets.ALLOWED_USER1_USERNAME }}"
                  allowed_user2="${{ secrets.ALLOWED_USER2_USERNAME }}"
                  allowed_user3="${{ secrets.ALLOWED_USER3_USERNAME }}"

                  if [[ "${{ github.actor }}" != "$allowed_user1" && \
                        "${{ github.actor }}" != "$allowed_user2" && \
                        "${{ github.actor }}" != "$allowed_user3" ]]; then
                    echo "‚ùå User '${{ github.actor }}' is not authorized to trigger this workflow."
                    echo "Only the following users can deploy to production:"
                    echo "  - $allowed_user1"
                    echo "  - $allowed_user2"
                    echo "  - $allowed_user3"
                    exit 1
                  else
                    echo "‚úÖ User '${{ github.actor }}' is authorized to deploy to production."
                  fi

            - name: Sync repo
              uses: actions/checkout@v3

            - name: Check if PR is from the same repo
              if: github.event_name == 'pull_request_target'
              id: check_repo
              run: echo "::set-output name=is_fork::$(if [[ '${{ github.event.pull_request.head.repo.full_name }}' != '${{ github.event.pull_request.base.repo.full_name }}' ]]; then echo true; else echo false; fi)"

            - name: Fetch the remote branch if it's a forked PR
              if: github.event_name == 'pull_request_target' && steps.check_repo.outputs.is_fork == 'true'
              run: |
                  git fetch origin pull/${{ github.event.number }}/head:${{ env.BRANCH_NAME }}
                  git checkout ${{ env.BRANCH_NAME }}

            - name: Checkout PR branch
              if: github.event_name == 'pull_request_target' && steps.check_repo.outputs.is_fork == 'false'
              uses: actions/checkout@v3
              with:
                  ref: ${{ github.event.pull_request.head.ref }}

            - name: Checkout specified branch
              if: github.event_name == 'workflow_dispatch'
              uses: actions/checkout@v3
              with:
                  ref: ${{ github.event.inputs.branch }}

            - name: Setup Node.js
              uses: actions/setup-node@v2
              with:
                  node-version: 22.15.1

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_PROD_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_PROD_ACCESS_KEY }}
                  aws-region: us-east-2

            - name: Install and build dependencies in order
              run: |
                  cd marketplace
                  echo "üîß Installing all workspace dependencies"
                  npm install

                  echo "üèóÔ∏è Building 'common' plugin first"
                  npm run build --workspace=plugins/common || exit 1

                  echo "üîÅ Building all remaining plugins"
                  PLUGINS=$(ls plugins | grep -v '^common$')
                  for plugin in $PLUGINS; do
                    echo "üî® Building plugin: $plugin"
                    npm run build --workspace=plugins/$plugin || exit 1
                  done

            - name: Build marketplace plugins and capture summary
              run: |
                  cd marketplace
                  echo "üöÄ Uploading to S3 Production"
                  AWS_BUCKET=${{ secrets.S3_BUCKET_PRODUCTION }} bash scripts/upload-to-s3.sh ${{ github.event.inputs.plugin_name }} | tee upload_summary.log

            - name: Extract upload summary
              id: upload_summary
              run: |
                  SUMMARY=$(awk '/UPLOAD SUMMARY/,0' marketplace/upload_summary.log)
                  echo "UPLOAD_SUMMARY<<EOF" >> $GITHUB_ENV
                  echo "$SUMMARY" >> $GITHUB_ENV
                  echo "EOF" >> $GITHUB_ENV

            - name: Output summary to logs (manual trigger)
              if: success() && github.event_name == 'workflow_dispatch'
              run: |
                  echo "========================================="
                  echo "PRODUCTION DEPLOYMENT SUMMARY"
                  echo "========================================="
                  echo "${{ env.UPLOAD_SUMMARY }}"
                  echo "========================================="

            - name: Comment on success
              if: success() && github.event_name == 'pull_request_target'
              uses: actions/github-script@v5
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const runId = process.env.GITHUB_RUN_ID;
                      const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${runId}`;
                      const summary = process.env.UPLOAD_SUMMARY;
                      const body = `‚úÖ Marketplace Plugin deployed to **PRODUCTION** bucket\n\nüîç [View Deployment Logs & Summary](${runUrl})\n\n\`\`\`\n${summary}\n\`\`\``;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body
                      });

            - name: Label update on success
              if: success() && github.event_name == 'pull_request_target'
              uses: actions/github-script@v6
              with:
                  script: |
                      try {
                        await github.rest.issues.removeLabel({
                          issue_number: context.issue.number,
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          name: 'deploy-marketplace-plugin-prod'
                        })
                      } catch (e) {
                        console.log(e)
                      }

                      await github.rest.issues.addLabels({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        labels: ['plugin-deployed-production']
                      })

            - name: Comment on failure
              if: failure() && github.event_name == 'pull_request_target'
              uses: actions/github-script@v6
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const runId = process.env.GITHUB_RUN_ID;
                      const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${runId}`;

                      await github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: `‚ùå Marketplace Plugin deployment to **PRODUCTION** failed.\n\nüîç [View Deployment Logs & Summary](${runUrl})`
                      });
