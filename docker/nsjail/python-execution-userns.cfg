# ============================================================================
# nsjail Configuration: USERNS Mode (Unprivileged User Namespaces)
# ============================================================================
#
# This configuration uses unprivileged user namespaces to achieve isolation
# WITHOUT requiring CAP_SYS_ADMIN. It provides the same namespace isolation
# as FULL mode, but cannot use cgroups v2 for hard resource limits.
#
# Requirements:
#  - kernel.unprivileged_userns_clone=1 (sysctl setting)
#  - Kernel 3.8+ (user namespaces)
#  - NO container privileges needed
#
# Limitations vs FULL mode:
#  - Uses rlimits instead of cgroups (soft limits)
#  - Memory limit less precise (RLIMIT_AS vs cgroup OOM killer)
#  - CPU limits via RLIMIT_CPU (not CPU quotas)
#
# ============================================================================

name: "tooljet-python-userns"
description: "ToolJet Python Execution - USERNS Mode (Unprivileged)"
mode: ONCE

# ============================================================================
# NAMESPACE ISOLATION - All 7 namespaces via user namespace
# ============================================================================

# User namespace MUST be first (enables other namespaces unprivileged)
clone_newuser: true     # User namespace - UID/GID mapping
clone_newns: true       # Mount namespace - Isolated filesystem
clone_newpid: true      # PID namespace - Process tree isolation
clone_newipc: true      # IPC namespace - No shared memory
clone_newuts: true      # UTS namespace - Hostname isolation
clone_newnet: true      # Network namespace - No network
clone_newcgroup: true   # Cgroup namespace - Resource view isolation

# Map sandbox user to nobody (UID 65534)
uidmap { inside_id: "0" outside_id: "65534" count: 1 }
gidmap { inside_id: "0" outside_id: "65534" count: 1 }

# ============================================================================
# CAPABILITIES AND PRIVILEGES
# ============================================================================

keep_caps: false
disable_no_new_privs: false

# ============================================================================
# TIME AND RESOURCE LIMITS (rlimits only - no cgroups)
# ============================================================================

# Wall-clock timeout
time_limit: 10

# CPU time limit
rlimit_cpu: 5

# Address space limit (512MB - main memory control mechanism)
rlimit_as: 536870912    # 512MB in bytes

# File size limit
rlimit_fsize: 1048576   # 1MB

# Open file descriptors
rlimit_nofile: 64

# Process limit
rlimit_nproc: 1

# Core dumps disabled
rlimit_core: 0

# ============================================================================
# CGROUPS V2 - Disabled (not available unprivileged)
# ============================================================================
# Unprivileged user namespaces cannot manipulate cgroups
# use_cgroupv2: false  # (commented out - not needed as it's default false)

# ============================================================================
# NETWORK ISOLATION
# ============================================================================

iface_no_lo: true

# ============================================================================
# FILESYSTEM MOUNTS
# ============================================================================

cwd: "/home"
hostname: "tooljet-sandbox"

# System libraries (read-only)
mount { src: "/usr" dst: "/usr" is_bind: true rw: false }
mount { src: "/lib" dst: "/lib" is_bind: true rw: false }
mount { src: "/lib64" dst: "/lib64" is_bind: true rw: false mandatory: false }
mount { src: "/usr/lib" dst: "/usr/lib" is_bind: true rw: false }
mount { src: "/etc/ld.so.cache" dst: "/etc/ld.so.cache" is_bind: true rw: false mandatory: false }

# Essential devices
mount { src: "/dev/null" dst: "/dev/null" is_bind: true rw: true }
mount { src: "/dev/zero" dst: "/dev/zero" is_bind: true rw: false }
mount { src: "/dev/urandom" dst: "/dev/urandom" is_bind: true rw: false }

# Writable tmpfs
mount { dst: "/home" fstype: "tmpfs" rw: true options: "size=52428800" }
mount { dst: "/tmp" fstype: "tmpfs" rw: true options: "size=16777216" }

# Minimal /etc files
mount { src_content: "sandbox:x:0:0:Sandbox User:/home:/bin/false" dst: "/etc/passwd" }
mount { src_content: "sandbox:x:0:" dst: "/etc/group" }

# ============================================================================
# ENVIRONMENT VARIABLES
# ============================================================================

keep_env: false

envar: "PATH=/usr/local/bin:/usr/bin:/bin"
envar: "HOME=/home"
envar: "PYTHONPATH=/packages/site-packages"
envar: "PYTHONDONTWRITEBYTECODE=1"
envar: "PYTHONUNBUFFERED=1"
envar: "LANG=C.UTF-8"
envar: "LC_ALL=C.UTF-8"
envar: "OMP_NUM_THREADS=2"
envar: "OPENBLAS_NUM_THREADS=2"
envar: "MKL_NUM_THREADS=2"

# ============================================================================
# SECCOMP SYSCALL FILTER (Same as FULL mode)
# ============================================================================

seccomp_string: "ERRNO(1) {"
seccomp_string: "    ptrace"
seccomp_string: "}"

seccomp_string: "KILL {"
seccomp_string: "    process_vm_readv,"
seccomp_string: "    process_vm_writev,"
seccomp_string: "    init_module,"
seccomp_string: "    finit_module,"
seccomp_string: "    delete_module,"
seccomp_string: "    kexec_load,"
seccomp_string: "    kexec_file_load,"
seccomp_string: "    reboot,"
seccomp_string: "    sethostname,"
seccomp_string: "    setdomainname,"
seccomp_string: "    unshare,"
seccomp_string: "    setns,"
seccomp_string: "    mount,"
seccomp_string: "    umount,"
seccomp_string: "    umount2,"
seccomp_string: "    pivot_root,"
seccomp_string: "    chroot,"
seccomp_string: "    perf_event_open,"
seccomp_string: "    bpf,"
seccomp_string: "    clone,"
seccomp_string: "    clone3"
seccomp_string: "}"

seccomp_string: "DEFAULT ALLOW"

# ============================================================================
# LOGGING
# ============================================================================

log_level: WARNING
log_fd: -1
